# EL-Workbench Development Guide

## Project Overview

**EL-Workbench** is a modular Python platform for controlling laboratory equipment and analyzing measurement data, primarily developed for electroluminescence measurement setups.

- **Language**: Python 3.12.5
- **GUI Framework**: PyQt6
- **Version**: 2.0.1 (as of main.py)
- **License**: MIT
- **Architecture**: Centralized SharedState with API-based data access

## Key Technologies & Dependencies

- **PyQt6**: Main GUI framework
- **NumPy**: Numerical computations and data handling
- **Matplotlib**: Plotting and data visualization
- **Seabreeze**: Ocean Optics spectrometer control
- **JSON**: Configuration and profile data storage

## Architecture Overview

### SharedState-Centric Design

The application follows a **SharedState-centric architecture** where:

- **SharedState** serves as the central hub for data sharing between modules
- **API classes** provide structured access to specific data domains (ProfileApi, future SmuApi, SpectrometerApi)
- **Tabs** handle UI logic and interact via SharedState
- **Transient data** (live measurements) can be accessed directly via SharedState attributes

### Core Components

- `main.py`: Application entry point, MainWindow, SharedState initialization
- `tabs/`: UI modules (QWidget derivatives) for different functionalities
- `data/profiles/`: Persistent profile data in JSON format
- `styles/`: UI theming (dark theme implementation)
- `other/`: Utility modules (device dialogs, info management)

## File Structure & Responsibilities

### Core Files

- **main.py**: Application startup, SharedState initialization, tab loading
- **design_rules.md**: Comprehensive architecture and coding guidelines
- **README.md**: Project documentation (bilingual German/English)

### Directories

| Directory | Purpose | Key Files |
|-----------|---------|-----------|
| `tabs/` | UI modules for different functionalities | `profile_tab.py`, `spectrum_tab.py`, `smu_tab.py`, `sweep_tab.py`, `settings_tab.py` |
| `data/profiles/` | Persistent profile configurations | JSON files with UUID names, `last_profile.json` |
| `styles/` | UI styling and themes | `dark_theme.py`, `realdarkmode.py` |
| `other/` | Utility modules | `device_dialog.py`, `info.py` |
| `api/` | API classes for structured data access | `profile_api.py` (others planned) |

## Development Guidelines

### SharedState Usage Rules

1. **Primary Interface**: Use SharedState as the main interface for data sharing between modules
2. **API Access**: Prefer API classes for complex data operations (e.g., `shared_data.profile_api`)
3. **Direct Attributes**: Use direct SharedState attributes only for transient/live data (e.g., `current_wavelengths`, `current_intensities`)
4. **Device References**: Store device instances as `shared_data.[device_name]_device`

### Naming Conventions

- **Data attributes**: `shared_data.[domain_dataname]` (e.g., `current_profile`, `current_wavelengths`)
- **Device instances**: `shared_data.[devicename]_device` (e.g., `smu_device`, `spectrometer_device`)
- **Control methods**: `shared_data.[devicename]_[action]` (e.g., `smu_apply_and_measure`)

### Tab Development

1. **Inheritance**: All tabs inherit from `QWidget`
2. **Constructor**: Accept `shared_data` parameter for SharedState access
3. **Responsibility**: Each tab owns its UI logic and data persistence
4. **Communication**: Interact with other tabs only through SharedState
5. **Data Ownership**: Tabs that generate data are responsible for persistence

### Data Management

1. **Persistent Data**: Store in JSON format with UUID identifiers
2. **Profile Structure**: Include `id` (UUID) and `name` fields
3. **Data Copies**: Return copies of data dictionaries to prevent unintended modifications
4. **Error Handling**: Wrap critical operations (file I/O, device communication) in try-except blocks

## Key Modules

### Profile Management (`tabs/profile_tab.py`)
- Manages user profiles and associated devices
- Handles profile creation, editing, deletion
- Persists data to JSON files in `data/profiles/`
- Updates `shared_data.current_profile` and `shared_data.current_device`

### Spectrometer Control (`tabs/spectrum_tab.py`)
- Controls Ocean Optics spectrometers via Seabreeze
- Provides dummy mode for testing
- Updates `shared_data.current_wavelengths` and `shared_data.current_intensities`
- Handles device connection/disconnection

### SMU Control (`tabs/smu_tab.py`)
- Controls Keithley SMU devices
- Provides current/voltage measurement capabilities
- Stores device reference in `shared_data.smu_device`

### Info Management (`other/info.py`)
- Centralized logging and status reporting
- Provides InfoManager for status messages
- InfoWidget for UI status display

## Adding New Modules

### Creating a New Tab

1. Create new file in `tabs/` directory
2. Inherit from `QWidget`
3. Accept `shared_data` parameter in constructor
4. Register in `main.py` `load_modules()` method
5. Follow naming conventions for SharedState interactions

### Creating a New API

1. Create new file in `api/` directory (create directory if needed)
2. Implement API class with SharedState reference
3. Initialize in `main.py` and assign to SharedState
4. Follow existing patterns from `ProfileApi`

## Testing & Development

### Dummy Modes
- Spectrometer tab includes dummy mode for development without hardware
- SMU operations should include simulation capabilities
- Use dummy modes for testing UI without physical devices

### Error Handling
- Implement robust error handling for device communication
- Provide user feedback via QMessageBox or status messages
- Use InfoManager for consistent status reporting

## Code Quality Standards

### Documentation
- Include comprehensive docstrings for all classes and methods
- Maintain change logs in file headers
- Update README.md when adding major features
- Comment complex logic with "why" not just "what"

### Imports
- Use specific imports: `from module.submodule import ClassName`
- Prefer relative imports within packages where applicable
- Group imports logically (standard library, third-party, local)

### File Organization
- Keep related functionality together
- Use clear, descriptive file and class names
- Maintain consistent directory structure
- Separate UI logic from business logic

## Common Patterns

### Device Connection Pattern
```python
# In tab __init__
self.shared_data = shared_data
self.device = None

# Connection method
def connect_device(self):
    try:
        self.device = DeviceClass()
        self.shared_data.device_name_device = self.device
        self.shared_data.info_manager.status(InfoManager.INFO, "Device connected")
    except Exception as e:
        self.shared_data.info_manager.status(InfoManager.ERROR, f"Connection failed: {e}")
```

### Data Update Pattern
```python
# For transient data
self.shared_data.current_wavelengths = wavelength_array
self.shared_data.current_intensities = intensity_array

# For persistent data via API
self.shared_data.profile_api.save_profile(profile_data)
```

## Future Development

### Planned APIs
- `SmuApi`: For SMU device control and measurement
- `SpectrometerApi`: For spectrometer operations
- `SettingsApi`: For application configuration

### Extension Points
- New measurement types can be added as tabs
- Device drivers can be added to `devices/` directory
- Analysis modules can extend the beispiel_tab pattern

## Migration Notes

This project has migrated from direct SharedState data access to an API-centric approach. When working with existing code:

- Legacy direct data access may still exist in some modules
- New development should prefer API classes where available
- Transient measurement data still uses direct SharedState attributes as intended